<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="report_invoice_retention_letter">
        <t t-call="web.external_layout">
            <t t-set="total_retention" t-value="abs(sum([float(a[3][str.find(a[3], ' ')+1:]) for a in o.amount_by_group if float(a[3][str.find(a[3], ' ')+1:]) &lt; 0]))"/>
            <div class="page">
                <p>Santo Domingo, R.D.<br/><span t-field="o.invoice_date" t-options='{"format": "d"}'/> de <span t-field="o.invoice_date" t-options='{"format": "MMMM"}'/> de <span t-field="o.invoice_date" t-options='{"format": "Y"}'/></p>
                <p><b>Señores:</b></p>
                <p>Dirección General De Impuestos Internos<br/>Santo Domingo, R.D.</p>
                <h5 style="text-align:center"><b>Certificación retención ITBIS e ISR</b></h5>
                <p>Distinguido Señor Director:</p>
                <p style="text-align:justify">Por medio de la presente certificamos que de acuerdo con lo dispuesto en la Ley 11 -92 Código Tributario de la República Dominicana, en su Título I, Artículo No.8 Agentes de Retención o Percepción y los artículos Nos.1, 2 y 5 de la Norma General No. 02-05 Sobre Agentes de Retención del ITBIS, hemos retenido a la Empresa <b><span t-esc="o.partner_id.parent_id.name or o.partner_id.name"/></b> con el <b>RNC No.<span t-esc="o.partner_id.parent_id.vat or o.partner_id.vat"/></b>, la suma total de <b>RD$ <t t-esc="total_retention"/></b> por concepto retención ITBIS e ISR de la o las factura (s) detallada (s) a continuación:</p>
                <br/>
                <table class="table table-sm o_main_table">
                    <thead>
                        <tr>
                            <th><span>Fecha</span></th>
                            <th><span>NCF</span></th>
                            <th><span>Subtotal</span></th>
                            <t t-foreach="o.amount_by_group" t-as="amount_by_group">
                                <th><span t-esc="amount_by_group[0]"/></th>
                            </t>
                            <th><span>Valor Total</span></th>
                            <th><span>Valor pagado</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><p class="m-0" t-field="o.invoice_date"/></td>
                            <td><p class="m-0" t-field="o.ncf"/></td>
                            <td><p class="m-0" t-esc="o.amount_untaxed"/></td>
                            <t t-foreach="o.amount_by_group" t-as="amount_by_group">
                                <td><span t-esc="abs(float(amount_by_group[3][str.find(amount_by_group[3], ' ')+1:]))"/></td>
                            </t>
                            <t t-if="len(o.amount_by_group)>2">
                                <t t-if="o.amount_untaxed != o.amount_by_group[2]">
                                    <t t-set="valor_total" t-value="sum([float(group[3][str.find(group[3], ' ')+1:]) for group in o.amount_by_group if float(group[3][str.find(group[3], ' ')+1:]) > 0])"/>
                                    <td><span class="text-nowrap" t-esc="valor_total"/></td>
                                </t>
                            </t>
                            <t t-else="">
                                <td><span class="text-nowrap" t-esc="o.amount_total"/></td>
                            </t>

                            <td><span class="text-nowrap" t-esc="o.amount_total"/></td>
                        </tr>
                    </tbody>
                </table>
                <br/>
                <p>Dicha retención será reportada en nuestra declaración de ITBIS del citado mes.</p>
                <p>El presente documento se expide como constancia, para los fines de lugar.</p>
                <p>Muy atentamente,</p>
                <p>Lic. Henry Castro</p>
                <hr/>
                <p><b>Dpto. Contabilidad.</b></p>
            </div>
        </t>
    </template>

    <template id="report_retention_letter">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="ipx_retention_letter.report_invoice_retention_letter" t-lang="o.partner_id.lang"/>
            </t>
        </t>
    </template>

    <report
        id="ipx_retention_letter_report"
        model="account.move"
        string="Retention Letter"
        name="ipx_retention_letter.report_retention_letter"
        report_type="qweb-pdf"
        print_report_name="'Retention Letter ' + object._get_report_base_filename()"
        attachment_use="True"
        attachment="(object.state in ('open','paid')) and
            ('Retention Letter INV'+(object.number or '').replace('/','')+'.pdf')"
    />
</odoo>
